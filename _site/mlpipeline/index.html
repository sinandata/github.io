<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">

  <title>Machine Learning Pipeline</title>

  <meta name="author" content="Sinan Gok" />

  
  <meta name="description" content="Ranked 54th (~2%) among 2848 participants">
  

  <link rel="alternate" type="application/rss+xml" title="Sinan Gok, PhD - My data science portfolio" href="http://localhost:4000/feed.xml" />

  

  

  


  
    
      
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />


    
  

  
    
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/css/bootstrap-social.css" />
    
      <link rel="stylesheet" href="/css/main.css" />
    
  

  
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

  

  

  

    <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="Machine Learning Pipeline" />
  

   
  <meta property="og:description" content="Ranked 54th (~2%) among 2848 participants">
  


  <meta property="og:type" content="website" />

  
  <meta property="og:url" content="http://localhost:4000/mlpipeline/" />
  <link rel="canonical" href="http://localhost:4000/mlpipeline/" />
  

  
  <meta property="og:image" content="http://localhost:4000/img/sakal-profile.jpeg" />
  


  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
  <meta name="twitter:title" content="Machine Learning Pipeline" />
  

  
  <meta name="twitter:description" content="Ranked 54th (~2%) among 2848 participants">
  

  
  <meta name="twitter:image" content="http://localhost:4000/img/sakal-profile.jpeg" />
  

  

  

</head>


  <body>

    

  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button><a class="navbar-brand" href="http://localhost:4000/">Sinan Gok, PhD</a></div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
          <li><a href="/aboutme">About Me</a></li>
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Showcase</a>
            <div class="navlinks-children">
              <a href="/mlpipeline">ML Pipeline</a>
            </div>
          </li>
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Articles</a>
            <div class="navlinks-children">
              <a href="https://medium.com/@goksinan/object-oriented-programming-oop-in-python-a-short-introduction-cd32b4c84393">OOP in Python</a>
              <a href="https://medium.com/@goksinan/demystifying-the-name-check-in-python-dce439472a83">The __name__ check</a>
            </div>
          </li>
        
          <li><a href="/resources">Resources</a></li></ul>
    </div>

	
	<div class="avatar-container">
	  <div class="avatar-img-border">
	    <a href="http://localhost:4000/">
	      <img class="avatar-img" src="/img/sakal-profile.jpeg" />
		</a>
	  </div>
	</div>
	

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-heading">
          <h1>Machine Learning Pipeline</h1>
		  
		    
            <hr class="small">
            <span class="page-subheading">Ranked 54th (~2%) among 2848 participants</span>
			
		  
		  
		  
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <h1 id="big-mart-sales-prediction">Big Mart Sales Prediction</h1>

<p><strong>Source:</strong> Data science competition at <a href="https://datahack.analyticsvidhya.com/contest/practice-problem-big-mart-sales-iii/">Analytics Vidhya</a></p>

<p>The dataset includes information about 1559 products that were sold in 10 different stores in 2013. There are various attributes that are associated to each product and store. Our goals is to train a predictive model which can predict the future sales of products given both store and item attributes.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>variables   : [['Item_Identifier'],
               ['Item_Weight'],
               ['Item_Fat_Content'],
               ['Item_Visibility'],
               ['Item_Type'],
               ['Item_MRP'],
               ['Outlet_Identifier'],
               ['Outlet_Establishment_Year'],
               ['Outlet_Size'],
               ['Outlet_Location_Type'],
               ['Outlet_Type'],
               ['Item_Outlet_Sales']]

train shape : 8523 rows, 12 columns  (the last attribute is the target)
test shape  : 5681 rows, 11 columns
</code></pre></div></div>

<p><strong>Data science problem:</strong> Predict product sales based on product and store attributes.</p>

<p>Steps of our data science process:</p>

<ol>
  <li>Set the research goal: Find out the future sales of products in a particular store</li>
  <li>Acquire data: Data is available as part of a data science competition</li>
  <li>Explore data: Basic data exploration</li>
  <li>Plan strategy: Determine strategies to treat missing data, engineer new features</li>
  <li>Build pipeline: Build an ML pipeline</li>
  <li>Build model: Compare different predictive models</li>
  <li>Conclusion: My ranking in competition</li>
</ol>

<ul>
  <li>Link to <a href="https://github.com/goksinan/bigmart_sales_public">GitHub repo</a></li>
</ul>

<p><em>Note: I will use a Machine Learning pipeline using the Scikit-learn library. Pipelines allow code reuse and consistence in handling training and test sets.</em></p>

<h2 id="1-research-goal">1. Research goal</h2>

<p>The goal is to be able to predict the sales of certain products in particular stores. Such an information is very valuable since we can:</p>
<ul>
  <li>Notice the fluctuations in product sales and we take actions</li>
  <li>Divert products to stores where they are more popular</li>
  <li>Figure out what attributes are associated with popular products</li>
</ul>

<h2 id="2-acquire-data">2. Acquire data</h2>

<p>Training and test data were downloaded to the working directory from the competitionâ€™s website.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Imports</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">'ignore'</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></div></div>

<p>Read file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">"train-file.csv"</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">"test-file.csv"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="3-explore-data">3. Explore data</h2>

<p>Examine file content:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(8523, 12)

array([['Item_Identifier'],
       ['Item_Weight'],
       ['Item_Fat_Content'],
       ['Item_Visibility'],
       ['Item_Type'],
       ['Item_MRP'],
       ['Outlet_Identifier'],
       ['Outlet_Establishment_Year'],
       ['Outlet_Size'],
       ['Outlet_Location_Type'],
       ['Outlet_Type'],
       ['Item_Outlet_Sales']], dtype=object)
</code></pre></div></div>

<p>There are 6 item (product) attributes, and 5 outlet (store) attibutes. Note that the <em>Item_Outlet_Sales</em> is the target variable.</p>

<p>The attribute names are fairly self explanatory. The <em>Item_Identifier</em> has unique items for each product, while the <em>Outlet_Identifier</em> holds codes regarding the outlets.</p>

<p>Letâ€™s take a look at the first few lines to have a general idea about the data types and values:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Item_Identifier</th>
      <th>Item_Weight</th>
      <th>Item_Fat_Content</th>
      <th>Item_Visibility</th>
      <th>Item_Type</th>
      <th>Item_MRP</th>
      <th>Outlet_Identifier</th>
      <th>Outlet_Establishment_Year</th>
      <th>Outlet_Size</th>
      <th>Outlet_Location_Type</th>
      <th>Outlet_Type</th>
      <th>Item_Outlet_Sales</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>FDA15</td>
      <td>9.30</td>
      <td>Low Fat</td>
      <td>0.016047</td>
      <td>Dairy</td>
      <td>249.8092</td>
      <td>OUT049</td>
      <td>1999</td>
      <td>Medium</td>
      <td>Tier 1</td>
      <td>Supermarket Type1</td>
      <td>3735.1380</td>
    </tr>
    <tr>
      <th>1</th>
      <td>DRC01</td>
      <td>5.92</td>
      <td>Regular</td>
      <td>0.019278</td>
      <td>Soft Drinks</td>
      <td>48.2692</td>
      <td>OUT018</td>
      <td>2009</td>
      <td>Medium</td>
      <td>Tier 3</td>
      <td>Supermarket Type2</td>
      <td>443.4228</td>
    </tr>
    <tr>
      <th>2</th>
      <td>FDN15</td>
      <td>17.50</td>
      <td>Low Fat</td>
      <td>0.016760</td>
      <td>Meat</td>
      <td>141.6180</td>
      <td>OUT049</td>
      <td>1999</td>
      <td>Medium</td>
      <td>Tier 1</td>
      <td>Supermarket Type1</td>
      <td>2097.2700</td>
    </tr>
    <tr>
      <th>3</th>
      <td>FDX07</td>
      <td>19.20</td>
      <td>Regular</td>
      <td>0.000000</td>
      <td>Fruits and Vegetables</td>
      <td>182.0950</td>
      <td>OUT010</td>
      <td>1998</td>
      <td>NaN</td>
      <td>Tier 3</td>
      <td>Grocery Store</td>
      <td>732.3800</td>
    </tr>
    <tr>
      <th>4</th>
      <td>NCD19</td>
      <td>8.93</td>
      <td>Low Fat</td>
      <td>0.000000</td>
      <td>Household</td>
      <td>53.8614</td>
      <td>OUT013</td>
      <td>1987</td>
      <td>High</td>
      <td>Tier 3</td>
      <td>Supermarket Type1</td>
      <td>994.7052</td>
    </tr>
  </tbody>
</table>
</div>

<p>From the table above, I can see that some of the variables are categorical. A categorical variableâ€™s data type is <code class="highlighter-rouge">object</code>, whereas numerical variables can be <code class="highlighter-rouge">float64</code> or <code class="highlighter-rouge">int64</code>. Letâ€™s see which variables are categorical:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">'Categorical Variables:'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'----------------------'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">train</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">==</span><span class="s">'object'</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Categorical Variables:
----------------------
Item_Identifier
Item_Fat_Content
Item_Type
Outlet_Identifier
Outlet_Size
Outlet_Location_Type
Outlet_Type
</code></pre></div></div>

<p>I continue to examine data. One of the best ways of seeing the big picture is looking at the number of unique values in a variable and if it has any missing values. I am going to write a custom function that reports that:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">my_summary</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">isnull</span><span class="p">()))</span>  <span class="c"># missing values</span>
    <span class="n">df3</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>  <span class="c"># missing values</span>

    <span class="n">dfx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dfx</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'count'</span><span class="p">,</span> <span class="s">'NaN'</span><span class="p">,</span> <span class="s">'Unique'</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">dfx</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">my_summary</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>  <span class="c"># Details variables</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                           count   NaN  Unique
Item_Identifier             8523     0    1559
Item_Weight                 7060  1463     416
Item_Fat_Content            8523     0       5
Item_Visibility             8523     0    7880
Item_Type                   8523     0      16
Item_MRP                    8523     0    5938
Outlet_Identifier           8523     0      10
Outlet_Establishment_Year   8523     0       9
Outlet_Size                 6113  2410       4
Outlet_Location_Type        8523     0       3
Outlet_Type                 8523     0       4
Item_Outlet_Sales           8523     0    3493
</code></pre></div></div>

<p>From the above summary, I immediately notice two things:</p>
<ol>
  <li><em>Item_Weight</em> and <em>Outlet_Size</em> needs to be treated for missing values</li>
  <li><em>Item_Identifier</em> is a categorical variable, but it has too many unique values. I have to find a way to either transform it to a numerical variable, or somehow reduce its dimensions if I want to use it in my model.</li>
</ol>

<p>I havenâ€™t started cleaning the data yet. I need to take a closer look at the categorical variables to see if they need any treatment before moving on:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cat_var</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Item_Identifier'</span><span class="p">,</span> <span class="s">'Item_Fat_Content'</span><span class="p">,</span> <span class="s">'Item_Type'</span><span class="p">,</span> <span class="s">'Outlet_Identifier'</span><span class="p">,</span>
               <span class="s">'Outlet_Size'</span><span class="p">,</span> <span class="s">'Outlet_Location_Type'</span><span class="p">,</span> <span class="s">'Outlet_Type'</span><span class="p">]</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cat_var</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'---'</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FDW13    10
FDG33    10
FDX20     9
FDV60     9
NCQ06     9
         ..
FDC23     1
FDO33     1
FDN52     1
DRF48     1
FDE52     1
Name: Item_Identifier, Length: 1559, dtype: int64
---
Low Fat    5089
Regular    2889
LF          316
reg         117
low fat     112
Name: Item_Fat_Content, dtype: int64
---
Fruits and Vegetables    1232
Snack Foods              1200
Household                 910
Frozen Foods              856
Dairy                     682
Canned                    649
Baking Goods              648
Health and Hygiene        520
Soft Drinks               445
Meat                      425
Breads                    251
Hard Drinks               214
Others                    169
Starchy Foods             148
Breakfast                 110
Seafood                    64
Name: Item_Type, dtype: int64
---
OUT027    935
OUT013    932
OUT035    930
OUT049    930
OUT046    930
OUT045    929
OUT018    928
OUT017    926
OUT010    555
OUT019    528
Name: Outlet_Identifier, dtype: int64
---
Medium    2793
Small     2388
High       932
Name: Outlet_Size, dtype: int64
---
Tier 3    3350
Tier 2    2785
Tier 1    2388
Name: Outlet_Location_Type, dtype: int64
---
Supermarket Type1    5577
Grocery Store        1083
Supermarket Type3     935
Supermarket Type2     928
Name: Outlet_Type, dtype: int64
---
</code></pre></div></div>

<p>Again, I can make two important observations:</p>
<ol>
  <li>It looks like <em>Item_Identifier</em> starts with a 2-letter code and most items start with the same code. We can extract this information and use it in our model.</li>
  <li><em>Item_Fat_Content</em> has 5 unique values, but it looks like some of them represent the same thing. We need to fix that as well.</li>
</ol>

<p>Finally, letâ€™s take a look at the numerical variables to see if they need any treatment:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">num_var</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Item_Weight'</span><span class="p">,</span> <span class="s">'Item_Visibility'</span><span class="p">,</span> <span class="s">'Item_MRP'</span><span class="p">,</span> <span class="s">'Outlet_Establishment_Year'</span><span class="p">]</span>

<span class="n">train</span><span class="p">[</span><span class="n">num_var</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Item_Weight</th>
      <th>Item_Visibility</th>
      <th>Item_MRP</th>
      <th>Outlet_Establishment_Year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>9.300</td>
      <td>0.016047</td>
      <td>249.8092</td>
      <td>1999</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5.920</td>
      <td>0.019278</td>
      <td>48.2692</td>
      <td>2009</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17.500</td>
      <td>0.016760</td>
      <td>141.6180</td>
      <td>1999</td>
    </tr>
    <tr>
      <th>3</th>
      <td>19.200</td>
      <td>0.000000</td>
      <td>182.0950</td>
      <td>1998</td>
    </tr>
    <tr>
      <th>4</th>
      <td>8.930</td>
      <td>0.000000</td>
      <td>53.8614</td>
      <td>1987</td>
    </tr>
    <tr>
      <th>5</th>
      <td>10.395</td>
      <td>0.000000</td>
      <td>51.4008</td>
      <td>2009</td>
    </tr>
    <tr>
      <th>6</th>
      <td>13.650</td>
      <td>0.012741</td>
      <td>57.6588</td>
      <td>1987</td>
    </tr>
    <tr>
      <th>7</th>
      <td>NaN</td>
      <td>0.127470</td>
      <td>107.7622</td>
      <td>1985</td>
    </tr>
    <tr>
      <th>8</th>
      <td>16.200</td>
      <td>0.016687</td>
      <td>96.9726</td>
      <td>2002</td>
    </tr>
    <tr>
      <th>9</th>
      <td>19.200</td>
      <td>0.094450</td>
      <td>187.8214</td>
      <td>2007</td>
    </tr>
  </tbody>
</table>
</div>

<p>Two things:</p>
<ol>
  <li><em>Item_Visibility</em> represent the percent display area of a product. Since all products are visible to some degree, having a 0.0 visibility value doesnâ€™t make sense. These entries are probably missing. So, we have to find a way to replace these zeros with more meaningful values.</li>
  <li>Using outletâ€™s age instead of <em>Outlet_Establishment_Year</em> feels more natural.</li>
</ol>

<h2 id="4-action-plan">4. Action Plan</h2>

<p>At this point, I finally have a plan of action. My data cleaning process will be as follows:</p>
<ol>
  <li>Missing data treatment for
    <ul>
      <li><em>Item_Weight</em></li>
      <li><em>Item_Visibility</em></li>
      <li><em>Outlet_Size</em></li>
    </ul>
  </li>
  <li>Feature engineering
    <ul>
      <li>Create an extra feature using codes in the <em>Item_Identifier</em></li>
      <li>Fix overlapping namings in <em>Item_Fat_Content</em></li>
      <li>Use establishmentâ€™s age instead of <em>Outlet_Establishment_Year</em></li>
    </ul>
  </li>
</ol>

<p><strong>One very important note: I am NOT going to include the TEST set in the data cleaning process of the TRAINING set. Once I establish the rules in the TRAINING set, I will use the same rules to treat the TEST set.</strong></p>

<p><strong>For example, when treating the missing Item_Weight values the the TEST set, I am NOT going to look at the weight data in the TEST set. Instead, I am going to fill the missing values using the weight data in the TRAINING set.</strong></p>

<h3 id="i-missing-data-treatment---item_weight">i. Missing data treatment - <em>Item_Weight</em></h3>

<p>My approach is simple: If the weight is missing in a particular row, find the <em>Item_Identifier</em> in that row. Then, scan the whole data to see if other items with the same identifier have entries in the weight section. If yes, take the mean and plug in. If not, take the mean of all items weights, and plug in.</p>

<h3 id="ii-missing-data-treatment---item_visibility">ii. Missing data treatment - <em>Item_Visibility</em></h3>

<p>Same approach as above: Find all visibility entries for the same product, take the mean, plug it in as the missing value. If no visibility entry is avaible, take the mean visibility of all items and plug it in.</p>

<p>While we are at it, letâ€™s look at the histogram of the visibility data:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Item_Visibility</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/images/bigmart/hist_visib.png" alt="png" /></p>

<p>The distribution is skewed. We are going to take the square root of if to make it more normal.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">Outlet_Identifier</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">outlet</span><span class="p">,</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Identifier</span><span class="o">==</span><span class="n">outlet</span><span class="p">]</span><span class="o">.</span><span class="n">Item_Visibility</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OUT049 0.060805543674193545
OUT018 0.06101449825
OUT010 0.10145735520540541
OUT013 0.059956930729613736
OUT027 0.05861472116898396
OUT045 0.060474466806243264
OUT017 0.061376507714902814
OUT046 0.06046438195053763
OUT035 0.06126330468709677
OUT019 0.10844136560227273
</code></pre></div></div>

<p>Items in OUT010 and OUT019 rated more visible than items in the other stores on avarage.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">Outlet_Type</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">outlet</span><span class="p">,</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Type</span><span class="o">==</span><span class="n">outlet</span><span class="p">]</span><span class="o">.</span><span class="n">Item_Visibility</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Supermarket Type1 0.06072282399802762
Supermarket Type2 0.06101449825
Grocery Store 0.10486230210249307
Supermarket Type3 0.05861472116898396
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[</span><span class="s">'Item_Visibility_Rate'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Low'</span>
<span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Identifier</span> <span class="o">==</span> <span class="s">'OUT010'</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Identifier</span> <span class="o">==</span> <span class="s">'OUT019'</span><span class="p">),</span> <span class="s">'Item_Visibility_Rate'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'High'</span>
</code></pre></div></div>

<h3 id="iii-missing-data-treatment---outlet_size">iii. Missing data treatment - <em>Outlet_Size</em></h3>

<p>Outlet has many other features. Maybe, I can use them to determine the size of outlets which are missing this entry.</p>

<p>I am going to compute a simple cross tabulation of two factors. My goal is to take a look at the relationship between the <em>Outlet_Size</em> variable and the others. I am also going to use Chi-square statistics to determine if the relationship is significant.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2_contingency</span>

<span class="c"># Outlet_Size vs. Outlet_Type</span>
<span class="n">tab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="p">,</span> <span class="n">train</span><span class="o">.</span><span class="n">Outlet_Type</span><span class="p">)</span>
<span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Chi2 statistics p-value: '</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'------------------------------------------------------------'</span><span class="p">)</span>

<span class="c"># Outlet_Size vs. Outlet_Location_Type</span>
<span class="n">tab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="p">,</span> <span class="n">train</span><span class="o">.</span><span class="n">Outlet_Location_Type</span><span class="p">)</span>
<span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Chi2 statistics p-value: '</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'------------------------------------------------------------'</span><span class="p">)</span>

<span class="c"># Outlet_Size vs. Outlet_Establishment_Year</span>
<span class="n">tab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="p">,</span> <span class="n">train</span><span class="o">.</span><span class="n">Outlet_Establishment_Year</span><span class="p">)</span>
<span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Chi2 statistics p-value: '</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'------------------------------------------------------------'</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Outlet_Type  Grocery Store  Supermarket Type1  Supermarket Type2  \
Outlet_Size                                                        
High                     0                932                  0   
Medium                   0                930                928   
Small                  528               1860                  0   

Outlet_Type  Supermarket Type3  
Outlet_Size                     
High                         0  
Medium                     935  
Small                        0  
Chi2 statistics p-value:  0.0
------------------------------------------------------------
Outlet_Location_Type  Tier 1  Tier 2  Tier 3
Outlet_Size                                 
High                       0       0     932
Medium                   930       0    1863
Small                   1458     930       0
Chi2 statistics p-value:  0.0
------------------------------------------------------------
Outlet_Establishment_Year  1985  1987  1997  1999  2004  2009
Outlet_Size                                                  
High                          0   932     0     0     0     0
Medium                      935     0     0   930     0   928
Small                       528     0   930     0   930     0
Chi2 statistics p-value:  0.0
------------------------------------------------------------
</code></pre></div></div>

<p>Looks like there is no relationship between <em>Outlet_Size</em> and any of the other outlet features. I am going to take a closer look at the <em>Outlet_Type</em> and <em>Outlet_Location_Type</em> of the missing entries, and try to find a scheme to fill them by using the rest of the data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">Outlet_Type</span><span class="p">,</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">Outlet_Location_Type</span><span class="p">)</span>
<span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Outlet_Location_Type  Tier 2  Tier 3
Outlet_Type                         
Grocery Store              0     555
Supermarket Type1       1855       0
</code></pre></div></div>

<p>This tells us that the stores with missing Size values are either Grocery Stores with Tier 3 or Supermarket Type 1 with Tier 2. I am going to look at the rest of the data with the same pair combinations and see if they have the Size info avaiable:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[(</span><span class="o">~</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> \
      <span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Location_Type</span> <span class="o">==</span> <span class="s">'Tier 2'</span><span class="p">)</span> <span class="o">&amp;</span> \
      <span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Type</span> <span class="o">==</span> <span class="s">'Supermarket Type1'</span><span class="p">)]</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array(['Small'], dtype=object)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[(</span><span class="o">~</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> \
      <span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Location_Type</span> <span class="o">==</span> <span class="s">'Tier 3'</span><span class="p">)</span> <span class="o">&amp;</span> \
      <span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Type</span> <span class="o">==</span> <span class="s">'Grocery Store'</span><span class="p">)]</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([], dtype=object)
</code></pre></div></div>

<p>I just figured out two things:</p>
<ul>
  <li>All Supermarket Type 1 - Tier 2 are Small in size. I will simply fill Small whereever I see this pair</li>
  <li>There are no Grocery Stores - Tier 3 pair in the data. So I canâ€™t use the strategy I used above</li>
</ul>

<p>The only thing I can do at this point is I can look at all the Grocery Stores and see what size shows up the most frequent. Then, I will use that size to fill in the missing values:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[(</span><span class="o">~</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> \
      <span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Outlet_Type</span> <span class="o">==</span> <span class="s">'Grocery Store'</span><span class="p">)]</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array(['Small'], dtype=object)
</code></pre></div></div>

<p>They are all Small size.</p>

<p><strong>Strategy:</strong> all of the missing values in the <em>Outlet_Size</em> variable will be <strong><em>Small</em></strong>.</p>

<h3 id="iv-feature-engineering---item_identifier">iv. Feature engineering - <em>Item_Identifier</em></h3>

<p>The first two letters in Item_Identifier is a code that shows the category of the item. Letâ€™s see what these codes are:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">codes</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">Item_Identifier</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">codes</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array(['FD', 'DR', 'NC'], dtype=object)
</code></pre></div></div>

<p>So, there are 3 unique codes. Just to have an idea, letâ€™s see what type of items these codes are asscoiated with:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[</span><span class="n">codes</span> <span class="o">==</span> <span class="s">'FD'</span><span class="p">]</span><span class="o">.</span><span class="n">Item_Type</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0                    Dairy
2                     Meat
3    Fruits and Vegetables
5             Baking Goods
6              Snack Foods
Name: Item_Type, dtype: object
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[</span><span class="n">codes</span> <span class="o">==</span> <span class="s">'DR'</span><span class="p">]</span><span class="o">.</span><span class="n">Item_Type</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1     Soft Drinks
18    Hard Drinks
27    Hard Drinks
34    Soft Drinks
37    Soft Drinks
Name: Item_Type, dtype: object
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span><span class="p">[</span><span class="n">codes</span> <span class="o">==</span> <span class="s">'NC'</span><span class="p">]</span><span class="o">.</span><span class="n">Item_Type</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4              Household
16    Health and Hygiene
22             Household
25             Household
31    Health and Hygiene
Name: Item_Type, dtype: object
</code></pre></div></div>

<p>It is not necessary to know the names of the categories for model building purposes, but it might be helpful to later interpret the model. For that reason, we are going to name them such that:</p>
<ul>
  <li>FD: Foods</li>
  <li>DR: Drinks</li>
  <li>NC: Non-consumables</li>
</ul>

<p><strong>Strategy</strong>:</p>
<ul>
  <li>Create a new feature called <em>Item_Category</em> and drop <em>Item_Identifier</em>.</li>
</ul>

<h3 id="v-feature-engineering---item_fat_content">v. Feature engineering - <em>Item_Fat_Content</em></h3>

<p>There are actually only two categories in this variable, sometimes the same category is represented by different names. I will fix that:</p>

<p><strong>Strategy:</strong></p>
<ul>
  <li>Replace â€˜low fatâ€™ and â€˜LFâ€™ with â€˜Low Fatâ€™</li>
  <li>Replace â€˜regâ€™ with â€˜Regularâ€™</li>
</ul>

<h3 id="vi-feature-engineering---outlet_establishment_year">vi. Feature engineering - <em>Outlet_Establishment_Year</em></h3>

<p>Create a new feature called <em>Outlet_Age</em> and drop the <em>Outlet_Establishment_Year</em>. The data was collected in 2013, so I will use 2013 as the current year.</p>

<p><strong>Strategy:</strong></p>
<ul>
  <li>Outlet_Age = 2013 - Outlet_Establishment_Year</li>
</ul>

<h3 id="vii-feature-engineering---item_mrp">vii. Feature engineering - <em>Item_MRP</em></h3>

<p>Plotting the histogram of <em>Item_MRP</em> reveals that there are 4 distinct price categories.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Item_MRP</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">200</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/images/bigmart/hist_mrp.png" alt="png" /></p>

<p><strong>Strategy:</strong></p>

<p>I will create a new feauture called <em>Item_Price_Category</em> based on the following criteria:</p>
<ul>
  <li>MRP &lt; 68 : Cheap</li>
  <li>68 &lt; MRP &lt; 135 : Affordable</li>
  <li>135 &lt; MRP &lt; 202 : Pricey</li>
  <li>MRP &gt; 202 : Expensive</li>
</ul>

<h2 id="5-build-the-pipeline">5. Build the pipeline</h2>

<p>I am going to write custome transformations which will perform all the actions described above. These transformation will be added to pipeline and both training and test data will be pass through it. All transformers will accept pandas dataframe and return a dataframe. Letâ€™s start:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">TransformerMixin</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction</span> <span class="kn">import</span> <span class="n">DictVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</code></pre></div></div>

<p>The first transformer will be called <strong>SimpleColumnTransformer()</strong> will handle the following tasks:</p>
<ul>
  <li>Create Item_Category variable</li>
  <li>Fix Fat_Content variable</li>
  <li>Create Outlet_Year variable</li>
  <li>Create Item_Price_Category feature</li>
  <li>Fill Outlet_Size variable</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SimpleColumnTransformer</span><span class="p">(</span><span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="s">'''
    This class will perform 5 transformations.
    By default, all 5 will be take place, but they can be skipped.
    '''</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fat_content</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">outlet_year</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">item_mrp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">outlet_size</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_id</span> <span class="o">=</span> <span class="n">item_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fat_content</span> <span class="o">=</span> <span class="n">fat_content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlet_year</span> <span class="o">=</span> <span class="n">outlet_year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_mrp</span> <span class="o">=</span> <span class="n">item_mrp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlet_size</span> <span class="o">=</span> <span class="n">outlet_size</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>  <span class="c"># stateless transformer</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>  <span class="c"># assumes X is a DataFrame</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_id</span><span class="p">:</span>
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s">'Item_Category'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">codes</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s">'Item_Identifier'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s">'Item_Category'</span><span class="p">]</span> <span class="o">=</span> <span class="n">codes</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fat_content</span><span class="p">:</span>
            <span class="n">X</span><span class="o">.</span><span class="n">Item_Fat_Content</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">Item_Fat_Content</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="s">'low fat'</span><span class="p">,</span> <span class="s">'LF'</span><span class="p">],</span> <span class="s">'Low Fat'</span><span class="p">)</span>
            <span class="n">X</span><span class="o">.</span><span class="n">Item_Fat_Content</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">Item_Fat_Content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'reg'</span><span class="p">,</span> <span class="s">'Regular'</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outlet_year</span><span class="p">:</span>
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s">'Outlet_Age'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2013</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">Outlet_Establishment_Year</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'Outlet_Establishment_Year'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># drop the redundant column</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_mrp</span><span class="p">:</span>
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s">'Item_Price_Category'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c"># create empty column first</span>
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">Item_MRP</span> <span class="o">&lt;</span> <span class="mi">68</span><span class="p">,</span> <span class="s">'Item_Price_Category'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Cheap'</span>
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">X</span><span class="o">.</span><span class="n">Item_MRP</span> <span class="o">&gt;</span> <span class="mi">68</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">Item_MRP</span> <span class="o">&lt;</span> <span class="mi">135</span><span class="p">),</span><span class="s">'Item_Price_Category'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Affordable'</span>
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">X</span><span class="o">.</span><span class="n">Item_MRP</span> <span class="o">&gt;</span> <span class="mi">135</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">Item_MRP</span> <span class="o">&lt;</span> <span class="mi">202</span><span class="p">),</span> <span class="s">'Item_Price_Category'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Pricey'</span>
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">Item_MRP</span> <span class="o">&gt;</span> <span class="mi">202</span><span class="p">,</span> <span class="s">'Item_Price_Category'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Expensive'</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outlet_size</span><span class="p">:</span>      
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">X</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> \
                  <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">Outlet_Location_Type</span> <span class="o">==</span> <span class="s">'Tier 2'</span><span class="p">)</span> <span class="o">&amp;</span> \
                  <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">Outlet_Type</span> <span class="o">==</span> <span class="s">'Supermarket Type1'</span><span class="p">),</span> <span class="s">'Outlet_Size'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Small'</span>

            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">X</span><span class="o">.</span><span class="n">Outlet_Size</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> \
                  <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">Outlet_Location_Type</span> <span class="o">==</span> <span class="s">'Tier 3'</span><span class="p">)</span> <span class="o">&amp;</span> \
                  <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">Outlet_Type</span> <span class="o">==</span> <span class="s">'Grocery Store'</span><span class="p">),</span> <span class="s">'Outlet_Size'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Small'</span>       

        <span class="k">return</span> <span class="n">X</span>
</code></pre></div></div>

<p>The second transformer will be called <strong>TreatWeight()</strong> and it will treat the missing data in Item_Weigth variable.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TreatWeight</span><span class="p">(</span><span class="n">TransformerMixin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">Item_Identifier</span><span class="p">:</span>
            <span class="n">replacement</span> <span class="o">=</span> <span class="n">X</span><span class="p">[(</span><span class="n">X</span><span class="o">.</span><span class="n">Item_Identifier</span> <span class="o">==</span> <span class="n">item</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">X</span><span class="o">.</span><span class="n">Item_Weight</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span><span class="o">.</span><span class="n">Item_Weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">replacement</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">Item_Weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">replacement</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c"># assumes X is a DataFrame</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">Item_Weight</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">Item_Identifier</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s">'Item_Weight'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">X</span>
</code></pre></div></div>

<p>The third transformer will be called <strong>TreatVisibility()</strong> and it will treat the missing data in Item_Visibility variable and take the square root of it.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TreatVisibility</span><span class="p">(</span><span class="n">TransformerMixin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visibs</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">Item_Identifier</span><span class="p">:</span>
            <span class="n">replacement</span> <span class="o">=</span> <span class="n">X</span><span class="p">[(</span><span class="n">X</span><span class="o">.</span><span class="n">Item_Identifier</span> <span class="o">==</span> <span class="n">item</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">Item_Visibility</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)]</span><span class="o">.</span><span class="n">Item_Visibility</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">replacement</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">Item_Visibility</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">replacement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visibs</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c"># assumes X is a DataFrame</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">Item_Visibility</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span><span class="o">.</span><span class="n">Item_Identifier</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s">'Item_Visibility'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visibs</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s">'Item_Visibility'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">Item_Visibility</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span>
</code></pre></div></div>

<p>The forth transformer will be called <strong>DummyTransformer()</strong> and it will perform One_Hot encoding.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DummyTransformer</span><span class="p">(</span><span class="n">TransformerMixin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c"># assumes X is a DataFrame</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span>
</code></pre></div></div>

<p>The fifth transformer will be called <strong>ZeroOneScaler()</strong> and it will perform Max Min Scaling.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ZeroOneScaler</span><span class="p">(</span><span class="n">TransformerMixin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c"># assumes X is a DataFrame</span>
        <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span>
</code></pre></div></div>

<p>The sixth and final transformer will be called <strong>ColumnExtractor()</strong> and it will return only selected features.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ColumnExtractor</span><span class="p">(</span><span class="n">TransformerMixin</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
        <span class="c"># assign columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># stateless transformer</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c"># assumes X is a DataFrame</span>
        <span class="n">Xcols</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Xcols</span>
</code></pre></div></div>

<p><strong>Create the pipeline and fit the training data</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Item_Category'</span><span class="p">,</span> <span class="s">'Item_Weight'</span><span class="p">,</span> <span class="s">'Item_Fat_Content'</span><span class="p">,</span>
             <span class="s">'Item_Visibility'</span><span class="p">,</span> <span class="s">'Item_MRP'</span><span class="p">,</span> <span class="s">'Item_Type'</span><span class="p">,</span> <span class="s">'Item_Price_Category'</span><span class="p">,</span>
             <span class="s">'Outlet_Type'</span><span class="p">,</span> <span class="s">'Outlet_Location_Type'</span><span class="p">,</span> <span class="s">'Outlet_Size'</span><span class="p">,</span> <span class="s">'Outlet_Age'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
            <span class="p">(</span><span class="s">'transform'</span><span class="p">,</span> <span class="n">SimpleColumnTransformer</span><span class="p">()),</span>
            <span class="p">(</span><span class="s">'weight'</span><span class="p">,</span> <span class="n">TreatWeight</span><span class="p">()),</span>
            <span class="p">(</span><span class="s">'visibility'</span><span class="p">,</span> <span class="n">TreatVisibility</span><span class="p">()),</span>
            <span class="p">(</span><span class="s">'extract'</span><span class="p">,</span> <span class="n">ColumnExtractor</span><span class="p">(</span><span class="n">FEATURES</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">'dummy'</span><span class="p">,</span> <span class="n">DummyTransformer</span><span class="p">())</span>
        <span class="p">])</span>

<span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Pipeline(memory=None,
         steps=[('transform',
                 &lt;__main__.SimpleColumnTransformer object at 0x123169f98&gt;),
                ('weight', &lt;__main__.TreatWeight object at 0x123169a90&gt;),
                ('visibility',
                 &lt;__main__.TreatVisibility object at 0x123169780&gt;),
                ('extract', &lt;__main__.ColumnExtractor object at 0x1231699b0&gt;),
                ('dummy', &lt;__main__.DummyTransformer object at 0x123169e48&gt;)],
         verbose=False)
</code></pre></div></div>

<p>Transform the training data:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_t</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">my_summary</span><span class="p">(</span><span class="n">train_t</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                                 count  NaN  Unique
Item_Weight                       8523    0     497
Item_Visibility                   8523    0    8322
Item_MRP                          8523    0    5938
Outlet_Age                        8523    0       9
Item_Category_FD                  8523    0       2
Item_Category_NC                  8523    0       2
Item_Fat_Content_Regular          8523    0       2
Item_Type_Breads                  8523    0       2
Item_Type_Breakfast               8523    0       2
Item_Type_Canned                  8523    0       2
Item_Type_Dairy                   8523    0       2
Item_Type_Frozen Foods            8523    0       2
Item_Type_Fruits and Vegetables   8523    0       2
Item_Type_Hard Drinks             8523    0       2
Item_Type_Health and Hygiene      8523    0       2
Item_Type_Household               8523    0       2
Item_Type_Meat                    8523    0       2
Item_Type_Others                  8523    0       2
Item_Type_Seafood                 8523    0       2
Item_Type_Snack Foods             8523    0       2
Item_Type_Soft Drinks             8523    0       2
Item_Type_Starchy Foods           8523    0       2
Item_Price_Category_Cheap         8523    0       2
Item_Price_Category_Expensive     8523    0       2
Item_Price_Category_Pricey        8523    0       2
Outlet_Type_Supermarket Type1     8523    0       2
Outlet_Type_Supermarket Type2     8523    0       2
Outlet_Type_Supermarket Type3     8523    0       2
Outlet_Location_Type_Tier 2       8523    0       2
Outlet_Location_Type_Tier 3       8523    0       2
Outlet_Size_Medium                8523    0       2
Outlet_Size_Small                 8523    0       2
</code></pre></div></div>

<p>See the data after transformations:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_t</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Item_Weight</th>
      <th>Item_Visibility</th>
      <th>Item_MRP</th>
      <th>Outlet_Age</th>
      <th>Item_Category_FD</th>
      <th>Item_Category_NC</th>
      <th>Item_Fat_Content_Regular</th>
      <th>Item_Type_Breads</th>
      <th>Item_Type_Breakfast</th>
      <th>Item_Type_Canned</th>
      <th>...</th>
      <th>Item_Price_Category_Cheap</th>
      <th>Item_Price_Category_Expensive</th>
      <th>Item_Price_Category_Pricey</th>
      <th>Outlet_Type_Supermarket Type1</th>
      <th>Outlet_Type_Supermarket Type2</th>
      <th>Outlet_Type_Supermarket Type3</th>
      <th>Outlet_Location_Type_Tier 2</th>
      <th>Outlet_Location_Type_Tier 3</th>
      <th>Outlet_Size_Medium</th>
      <th>Outlet_Size_Small</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>9.30</td>
      <td>0.126678</td>
      <td>249.8092</td>
      <td>14</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5.92</td>
      <td>0.138846</td>
      <td>48.2692</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17.50</td>
      <td>0.129461</td>
      <td>141.6180</td>
      <td>14</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>19.20</td>
      <td>0.151362</td>
      <td>182.0950</td>
      <td>15</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>8.93</td>
      <td>0.127139</td>
      <td>53.8614</td>
      <td>26</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows Ã— 32 columns</p>
</div>

<p>Transform the test data</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test_t</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="6-build-the-predictive-model">6. Build the predictive model</h2>

<p>I am going to build multiple models and compare them. For this, I am going to split my training data (train_t) into training and validation sets. These sets will be used to evaluate the modelsâ€™ performances.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># The target variable</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s">'Item_Outlet_Sales'</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="a-baseline-model">a. Baseline model</h3>

<p>There is no machine learning in Baseline solution. It is just a smart filling method. My strategy is as follows:</p>
<ul>
  <li>Identify the first item in test set and find its outlet_type and item_type</li>
  <li>Go to training set, find all the instances of the same item having the same outlet_type</li>
  <li>Take their mean. If it is a number, assign it as the prediction.</li>
  <li>If there are no such instances, find the all instances with the same item_type and take their mean. Assign it as the prediction value.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span>

<span class="k">class</span> <span class="nc">Baseline_Estimator</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predicts</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">XX</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">XX</span><span class="o">.</span><span class="n">Item_Identifier</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">XX</span><span class="p">[(</span><span class="n">XX</span><span class="o">.</span><span class="n">Item_Identifier</span> <span class="o">==</span> <span class="n">item</span><span class="p">)]</span><span class="o">.</span><span class="n">Item_Outlet_Sales</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predicts</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">XX</span><span class="p">):</span>
        <span class="c"># assumes X is a DataFrame</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">XX</span><span class="o">.</span><span class="n">Item_Identifier</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">XX</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s">'Item_Outlet_Sales'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predicts</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">XX</span><span class="o">.</span><span class="n">Item_Outlet_Sales</span>
</code></pre></div></div>

<p><strong>Validation dataset:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">base_model</span> <span class="o">=</span> <span class="n">Baseline_Estimator</span><span class="p">()</span>
<span class="n">base_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Baseline RMSE = "</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Baseline RMSE =  1660.614220132992
</code></pre></div></div>

<p><strong>Public dataset:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Final model</span>
<span class="n">base_model</span> <span class="o">=</span> <span class="n">Baseline_Estimator</span><span class="p">()</span>
<span class="n">base_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">test_target</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="c"># Export for submission</span>
<span class="n">test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s">'Item_Otlet_Sales'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_target</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">test</span><span class="p">[[</span><span class="s">'Item_Identifier'</span><span class="p">,</span> <span class="s">'Outlet_Identifier'</span><span class="p">,</span> <span class="s">'Item_Outlet_Sales'</span><span class="p">]]</span>
<span class="n">output</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'baseline_solution.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p>After submitting the baseline solution, the score is:</p>

<p><strong>(Public score) Baseline RMSE = 1598.68</strong></p>

<p>I am going to split the transformed training data here. All the upcomming models will use the same set of data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Split the transformed data (output of pipeline)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">train_t</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="b-linear-regression-with-recursive-feature-elimination">b. Linear Regression with Recursive Feature Elimination</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">RFECV</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>

<span class="n">estimator</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">selector</span> <span class="o">=</span> <span class="n">RFECV</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_features_to_select</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Validation dataset:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Selected features:'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">train_t</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">selector</span><span class="o">.</span><span class="n">support_</span><span class="p">])</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Selected features:
Index(['Item_Visibility', 'Item_MRP', 'Outlet_Age', 'Item_Category_FD',
       'Item_Category_NC', 'Item_Fat_Content_Regular', 'Item_Type_Breads',
       'Item_Type_Breakfast', 'Item_Type_Canned', 'Item_Type_Dairy',
       'Item_Type_Frozen Foods', 'Item_Type_Fruits and Vegetables',
       'Item_Type_Hard Drinks', 'Item_Type_Health and Hygiene',
       'Item_Type_Household', 'Item_Type_Meat', 'Item_Type_Others',
       'Item_Type_Seafood', 'Item_Type_Snack Foods', 'Item_Type_Soft Drinks',
       'Item_Type_Starchy Foods', 'Item_Price_Category_Cheap',
       'Item_Price_Category_Expensive', 'Item_Price_Category_Pricey',
       'Outlet_Type_Supermarket Type1', 'Outlet_Type_Supermarket Type2',
       'Outlet_Type_Supermarket Type3', 'Outlet_Location_Type_Tier 2',
       'Outlet_Location_Type_Tier 3', 'Outlet_Size_Medium',
       'Outlet_Size_Small'],
      dtype='object')
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Predict</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Linear Regression with feature elimination RMSE = "</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Linear Regression with feature elimination RMSE =  1103.6581075533286
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Final model</span>
<span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_t</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<span class="n">test_target</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_t</span><span class="p">)</span>

<span class="c"># Export</span>
<span class="n">test</span><span class="p">[</span><span class="s">'Item_Outlet_Sales'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_target</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">test</span><span class="p">[[</span><span class="s">'Item_Identifier'</span><span class="p">,</span> <span class="s">'Outlet_Identifier'</span><span class="p">,</span> <span class="s">'Item_Outlet_Sales'</span><span class="p">]]</span>
<span class="n">output</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'lr_rfecv.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>(Public score) Linear Regression with feature elimination RMSE = 1202.72</strong></p>

<h3 id="c-random-forest-with-hyperparameter-optimization">c. Random Forest with Hyperparameter optimization</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>

<span class="c"># Create the parameter grid based on the results of random search</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'bootstrap'</span><span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">],</span>
    <span class="s">'max_depth'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s">'n_estimators'</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
    <span class="s">'min_samples_leaf'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="p">}</span>

<span class="c"># Create a based model</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>

<span class="c"># Instantiate the grid search model</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span> <span class="o">=</span> <span class="n">rf</span><span class="p">,</span> <span class="n">param_grid</span> <span class="o">=</span> <span class="n">param_grid</span><span class="p">,</span>
                          <span class="n">cv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Validation dataset:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Fit the grid search to the data</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"RF hyp. opt. RMSE = "</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Fitting 3 folds for each of 162 candidates, totalling 486 fits


[Parallel(n_jobs=-1)]: Using backend LokyBackend with 4 concurrent workers.
[Parallel(n_jobs=-1)]: Done  33 tasks      | elapsed:   21.2s
[Parallel(n_jobs=-1)]: Done 154 tasks      | elapsed:  1.9min
[Parallel(n_jobs=-1)]: Done 357 tasks      | elapsed:  6.1min
[Parallel(n_jobs=-1)]: Done 486 out of 486 | elapsed:  9.6min finished


RF hyp. opt. RMSE =  1055.1096615622198
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'bootstrap': True, 'max_depth': 5, 'min_samples_leaf': 4, 'n_estimators': 400}
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">features</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="n">important_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">importances</span><span class="p">)</span> <span class="k">if</span> <span class="n">imp</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">]</span>
<span class="n">important_features</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['Item_Weight',
 'Item_Visibility',
 'Item_MRP',
 'Outlet_Age',
 'Item_Price_Category_Expensive',
 'Item_Price_Category_Pricey',
 'Outlet_Type_Supermarket Type1',
 'Outlet_Type_Supermarket Type2',
 'Outlet_Type_Supermarket Type3',
 'Outlet_Size_Medium',
 'Outlet_Size_Small']
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Fit the grid search to the data</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">important_features</span><span class="p">],</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">[</span><span class="n">important_features</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"RF hyp. opt. w/ feat. sel. RMSE = "</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RF hyp. opt. w/ feat. sel. RMSE =  1055.9962129317746
</code></pre></div></div>

<p>(!) Eliminating extra features did not improve.</p>

<p><strong>Public dataset:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Final model</span>
<span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_t</span><span class="p">[</span><span class="n">important_features</span><span class="p">],</span> <span class="n">target</span><span class="p">)</span>
<span class="n">test_target</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_t</span><span class="p">[</span><span class="n">important_features</span><span class="p">])</span>

<span class="c"># Export</span>
<span class="n">test</span><span class="p">[</span><span class="s">'Item_Outlet_Sales'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_target</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">test</span><span class="p">[[</span><span class="s">'Item_Identifier'</span><span class="p">,</span> <span class="s">'Outlet_Identifier'</span><span class="p">,</span> <span class="s">'Item_Outlet_Sales'</span><span class="p">]]</span>
<span class="n">output</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'rf_opt.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>(Public score) Random Forest with hyp. opt. RMSE = 1152.87</strong></p>

<h3 id="d-gradient-boosting-xgboost">d. Gradient Boosting (XGBoost)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="n">xgb</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xg_reg</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span><span class="n">objective</span> <span class="o">=</span><span class="s">'reg:squarederror'</span><span class="p">,</span> <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                <span class="n">max_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">booster</span><span class="o">=</span><span class="s">'gbtree'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">):</span>
    <span class="n">xg_reg</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="n">xg_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">xg_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>

    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"RMSE: </span><span class="si">%</span><span class="s">f"</span> <span class="o">%</span> <span class="p">(</span><span class="n">rmse</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Test:'</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Train:'</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">xg_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1
RMSE: 1160.838296
Test: 0.5192018616686835
Train: 0.510490531731213
2
RMSE: 1081.850445
Test: 0.5824064528995557
Train: 0.5897337467292103
3
RMSE: 1061.903953
Test: 0.5976631627068683
Train: 0.6222895799344221
4
RMSE: 1061.438149
Test: 0.5980160550685669
Train: 0.6460898298819107
5
RMSE: 1064.835118
Test: 0.5954389629480101
Train: 0.6726656160156788
6
RMSE: 1071.080403
Test: 0.5906795244477605
Train: 0.7083850581879783
7
RMSE: 1079.857821
Test: 0.583943339646801
Train: 0.7463497306484315
8
RMSE: 1088.994996
Test: 0.5768726564960911
Train: 0.7894435645706
9
RMSE: 1098.307415
Test: 0.5696050625078345
Train: 0.8287773376223277
10
RMSE: 1104.393786
Test: 0.5648216992713977
Train: 0.8593659152416984
</code></pre></div></div>

<p>The optimal max_depth is 4</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xg_reg</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">);</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">xg_reg</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="n">xg_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">xg_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>

    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"RMSE: </span><span class="si">%</span><span class="s">f"</span> <span class="o">%</span> <span class="p">(</span><span class="n">rmse</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Test:'</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Train:'</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">xg_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10
RMSE: 1453.030478
Test: 0.24669860693426338
Train: 0.21352559650290326
20
RMSE: 1184.415185
Test: 0.4994732915791157
Train: 0.4854732492968412
30
RMSE: 1101.239457
Test: 0.5673040301064218
Train: 0.5666178293774524
40
RMSE: 1075.829013
Test: 0.5870420539082549
Train: 0.5950895173054211
50
RMSE: 1062.367009
Test: 0.5973121985309007
Train: 0.6128186187478392
60
RMSE: 1059.846879
Test: 0.5992204313354104
Train: 0.6222275894074634
70
RMSE: 1059.242399
Test: 0.5996774671664933
Train: 0.6305362795616825
80
RMSE: 1058.777890
Test: 0.6000284971898948
Train: 0.6376172795698607
90
RMSE: 1060.119704
Test: 0.5990140680043802
Train: 0.6410912880921313
100
RMSE: 1061.438149
Test: 0.5980160550685669
Train: 0.6460898298819107
</code></pre></div></div>

<p>The optimal n_estimators is 80</p>

<p><strong>Validation dataset:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xg_reg</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">xg_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">xg_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"XGBoost RMSE = "</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>XGBoost RMSE =  1058.7778896684076
</code></pre></div></div>

<p><strong>Public dataset:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Final model</span>
<span class="n">xg_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_t</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<span class="n">test_target</span> <span class="o">=</span> <span class="n">xg_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_t</span><span class="p">)</span>

<span class="c"># Export</span>
<span class="n">test</span><span class="p">[</span><span class="s">'Item_Outlet_Sales'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_target</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">test</span><span class="p">[[</span><span class="s">'Item_Identifier'</span><span class="p">,</span> <span class="s">'Outlet_Identifier'</span><span class="p">,</span> <span class="s">'Item_Outlet_Sales'</span><span class="p">]]</span>
<span class="n">output</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'xgboost.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>(Public score) XGBoost RMSE = 1152.84</strong></p>

<h2 id="7-conclusion">7. Conclusion</h2>

<p>Most of the features do not generalize well and they can be considered as noise. By carefully eliminating those features and optimizing the parameters, it is possible to improve the RMSE score.</p>

<p>By tweaking the parameters of the Random Forests Model, I was able to achieve a public RMSE score of <strong>1143.05</strong> which was ranked 54th (~2%) among 2848 participants as of August 2019.</p>

	    
    </div>
  </div>
</div>


    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links"><li><a href="/feed.xml" title="RSS"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">RSS</span>
              </a>
            </li><li><a href="mailto:sgok7@yahoo.com" title="Email me"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Email me</span>
              </a>
            </li><li><a href="https://github.com/goksinan" title="GitHub"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">GitHub</span>
              </a>
            </li><li><a href="https://twitter.com/snn_gk" title="Twitter"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">Twitter</span>
              </a>
            </li><li><a href="https://linkedin.com/in/sinangok" title="LinkedIn"><span class="fa-stack fa-lg" aria-hidden="true">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                </span>
                <span class="sr-only">LinkedIn</span>
              </a>
            </li></ul>
      <p class="copyright text-muted">
      Sinan Gok
      &nbsp;&bull;&nbsp;
      2019

      
      &nbsp;&bull;&nbsp;
      <a href="http://localhost:4000/">Home</a>
      

      
      </p>
          <!-- Please don't remove this, keep my open source work credited :) -->
    <p class="theme-by text-muted">
      Theme by
      <a href="https://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    </p>
      </div>
    </div>
  </div>
</footer>

  
    


  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
      	if (typeof jQuery == 'undefined') {
          document.write('<script src="/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/js/main.js"></script>
    
  






  
  </body>
</html>
